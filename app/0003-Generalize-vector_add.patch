From 2f6fd568e079ef79d16ae1cb08a65143d38c777c Mon Sep 17 00:00:00 2001
From: Anastassios Nanos <ananos@nubificus.co.uk>
Date: Thu, 8 Apr 2021 21:21:27 +0100
Subject: [PATCH] Generalize vector_add

Signed-off-by: Anastassios Nanos <ananos@nubificus.co.uk>
---
 vector_add/CMakeLists.txt |  2 ++
 vector_add/vector_add.cpp | 18 +++++++++++++++++-
 2 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/vector_add/CMakeLists.txt b/vector_add/CMakeLists.txt
index dab44e6..ed76381 100755
--- a/vector_add/CMakeLists.txt
+++ b/vector_add/CMakeLists.txt
@@ -2,6 +2,8 @@ include_directories ("${PROJECT_SOURCE_DIR}/include" ${OpenCL_INCLUDE_DIRS})
 
 add_library(vector_add SHARED vector_add.cpp)
 target_compile_options(vector_add PUBLIC -Wall -Wextra )
+set_target_properties(vector_add PROPERTIES ENABLE_EXPORTS on)
+target_link_libraries(vector_add  ${OpenCL_LIBRARIES})
 set_property(TARGET vector_add PROPERTY LINK_FLAGS "-lOpenCL -shared")
 
 
diff --git a/vector_add/vector_add.cpp b/vector_add/vector_add.cpp
index a73e358..5e063f0 100755
--- a/vector_add/vector_add.cpp
+++ b/vector_add/vector_add.cpp
@@ -19,8 +19,24 @@
 
 //int main(){
 //extern "C" int vector_add(){
-extern "C" int vector_add (int* A, int* B, int* C, int dimension){
+//extern "C" int vector_add (int* A, int* B, int* C, int dimension){
+
+struct vector_arg {
+	uint32_t len;
+	uint8_t *buf;
+};
+
+extern "C" int vector_add (void*out_args, size_t out_nargs, void* in_args, size_t in_nargs){
 	try{
+		/* unpack arguments */
+		struct vector_arg *in_arg = (struct vector_arg*)in_args;
+		struct vector_arg *out_arg = (struct vector_arg*) out_args;
+
+		int dimension = *(int*)out_arg[2].buf;
+		int *A = (int*)out_arg[0].buf;
+		int *B = (int*)out_arg[1].buf;
+		int *C = (int*)in_arg[0].buf;
+
 		//get all platforms (drivers)
 		std::vector<cl::Platform> all_platforms;
 		cl::Platform::get(&all_platforms);
-- 
2.25.1

